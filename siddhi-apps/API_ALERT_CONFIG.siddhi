@App:name("API_ALERT_CONFIG")
@App:description("Store the alert configurations of each API into the table 'ApiAlertConfiguration' published through the stream 'org.wso2.apimgt.alert.configuration:1.0.0'")

@source(type = 'wso2event', wso2.stream.id = 'org.wso2.apimgt.alert.configuration:1.0.0', @map(type = 'wso2event'))
define stream AlertConfigurationStream (
    apiName string,
    apiVersion string,
    apiCreator string,
    apiCreatorTenantDomain string,
    thresholdResponseTime long,
    thresholdBackendTime long,
    thresholdRequestCountPerMin int);
    
@PrimaryKey('apiName', 'apiVersion','apiCreator', 'apiCreatorTenantDomain')
@store(type = 'rdbms', datasource = 'APIM_TEST')
define table ApiAlertConfiguration (apiName string, apiVersion string, apiCreator string, apiCreatorTenantDomain string, thresholdResponseTime long, thresholdBackendTime long,thresholdRequestCountPerMin int);

from AlertConfigurationStream
select * 
update or insert into ApiAlertConfiguration
set ApiAlertConfiguration.thresholdResponseTime = thresholdResponseTime, ApiAlertConfiguration.thresholdBackendTime = thresholdBackendTime, ApiAlertConfiguration.thresholdRequestCountPerMin = thresholdRequestCountPerMin
on ApiAlertConfiguration.apiName == apiName and ApiAlertConfiguration.apiVersion == apiVersion and ApiAlertConfiguration.apiCreator == apiCreator and ApiAlertConfiguration.apiCreatorTenantDomain == apiCreatorTenantDomain 
